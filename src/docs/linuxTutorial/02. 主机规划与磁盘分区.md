# 主机规划与磁盘划分

事实上，要安装好一部 Linux 主机并不是那么简单的事情，你必须要针对 distributions 的特性、服务器的软件能力、 未来的升级需求、硬 件扩充性需求等等来考虑，还得要知道磁盘分区、文件系统

## Linux 与 硬件的搭配

选购新的个人计算机时，需要注意某些硬件是否支持 linux，因为有些厂商对 linux 的驱动程序支持较慢

此外你需要用 linux 达成什么任务？也就是用途是什么？这样才知道哪个硬件才是最重要的。
举例来说，桌面电脑主要使用 x window，那么对于内存和显卡就显得比较重要了，
想要做成文件服务器，那么硬盘或则是其他存储设备比较重要

::: tip
再次强调，linux 对硬件设备的分辨与 windows 不同，在 linux 下面都是「文件」，
在学习 linux 设备文件名之前，务必要先将 windows 中的设备概念先拿掉
:::

## 认识计算机的硬件配备
主要部件有：

- CPU
- 内存
- 显卡
- 硬盘
- 主板

### 游戏机/工作机的考虑
对于游戏机来说，更高的 CPU、内存、显卡是必须的，
但是对于一般的办公室环境来说，入门级的计算机就行了，基本用来制作 ppt、word、网页浏览等工作

### 性能/价格比性能/消耗的瓦数考虑
买最新的硬件一般来说有可能 linux 下没有合适的驱动程序，而且价格贵。

另外耗电量也需要考虑，特别是在企业环境中，有机房集群什么的使用计算机的数量是很多的，
硬件评论界有所谓的「每瓦性能」，就是每瓦电力发挥的性能越高，就越省电，
比如做服务器用时，你的计算机比省电的计算机每天多花费 50 瓦电力时，50W*365*24小时/1000W = 438 度电，
以一度电 3 块钱来计算，就多花费十万电费

### 支持度的考虑
某些厂商没有意愿提供适当的驱动程序的话，那么你买了也在 linux 上运行不起来的

## 选择与 Linux 搭配的主机配备

由于硬件的加速发展与操作系统核心功能的增强，导致老旧的硬件在新的内核上支持不好，可能导致不明的死机状况，
所以选择与之匹配的硬件与操作系统版本是很有必要的

由于 linux 对硬件的要求不高，鸟哥的建议是，如果你有 5 年内的计算机被淘汰的话，可以先尝试一下，
说不定就能作为你日常生活的 linux 服务器或则是备用服务器

下面来稍微谈一下，如果你的需求是将 linux 作为小型服务器使用，不负责学术方面的大量运算，
也没有 x window，那么你的硬件需求只要像下面这样就够了

- CPU：2015 年中，intel i3 系列的 CPU 就可以了
- RAM: 当然是越大越好

  在 Linux 服务器中，内存的重要性比 CPU 还要高的多，内存不够就会用到交换空间（swap），
  而交换空间是使用硬盘存储的，硬盘比内存速度慢太多

  至少 512 MB，在 DDR3 的硬件环境中，4~16 GB 的内存够用了
- Hard Disk

  主要看你用来做什么，如果是小型服务器，一般容量大于 20 GB，就很够用了，如果是用来作为备份
  或小企业的文件服务器，那么可能就得需要磁盘阵列（RAID)模式了（Raid 利用硬件技术将多个硬盘整合为一个大硬盘的方法）
- VGA

  不需要 x window 的话，只要最基础的显卡能让计算机启动就行了，否则至少拥有 32 MB以上的显存容量，
  不然 x window 可能会很卡
- Network Interface Card

  网卡是服务器上面最重要的元件之一了。大多主板内置 10/100/1000 Mbps 的超高速显卡。
  但是有不同的差异，比如具有设置 bonding 功能的网卡，较好的网卡驱动也做得比较好，
  如果是网络 I/O 频繁的需求，那么可以选用 intel/boradcom 等公司的网卡
- 光盘、软盘、键盘与鼠标

  基本上可以不准备了，一般安装好之后，都会拔掉，通过终端来管理

### 小型主机且不含 x window 系统硬件推荐

用途：家庭用 NAT 主机（IP 分享器功能）或小型企业之非图形接口小型主机

- CPU：五年内出产的产品即可
- RAM：至少 512 MB，大于 1 GB 最好
- 网卡：一般的以太网卡即可应付
- 显卡：只要能被 Linux 捉到的显卡即可，例如 Nvidia 或 Ati 的主流显卡
- 硬盘：20 GB 以上即可


### 桌上型含 x window 系统
用途：Linux 的练习机或办公室（Office）工作机（一般我们会用到的环境）

- CPU：最好等级高一点，例如 Intel I5, I7 以上等级。
- RAM：一定要大于 1GB 比较好!否则容易有图形接口停顿的现象。
- 网卡：普通的以太网卡就好了!
- 显卡：使用 256 MB 以上内存的显卡!(入门级的都这个容量以上了)
- 硬盘：越大越好，最好有 60 GB。

### 中型以上 Linux 服务器
用途：中小型企业/学校单位的 FTP、mail、wwww 等网络服务主机

- CPU：最好等级高一点，例如 I5, I7 以上的多核心系统。
- RAM: 最好能够大于 1GB 以上，大于 4GB 更好!
- 网卡: 知名的 broadcom 或 Intel 等厂牌，比较稳定性能较佳!
- 显卡: 如果有使用到图形功能，则一张 64 MB 内存的显卡是需要的!
- 硬盘: 越大越好，如果可能的话，使用磁盘阵列，或者网络硬盘等等的系统架构， 能够具有更稳定安全的传输环境，更 佳!

建议企业用计算机不要自行组装，可购买商用服务器较佳， 因为商用服务器已经通过制造商的散热、稳定性等测试，对 于企业来说，会是一个比较好的选择。

总之这里提供一个方向，根据自己的需求选购。

### distribution 对硬件的支持

linux 开发商在释出 linux distribution 之前，都会针对该版所默认可以支持的硬件做说明，
除了可以在 linux 的 Howto 文件去查询硬件的支持度外，也可以到具体的网站查询，
下面列出几个常用的 distribution 网站

- Red Hat 的硬件支持：https://hardware.redhat.com/?pagename=hcl
- Open SuSE 的硬件支持：http://en.opensuse.org/Hardware?LANG=en_UK
- Linux 对笔记本电脑的支持：http://www.linux-laptop.net/
- Linux 对打印机的支持：http://www.openprinting.org/
- Linux 硬件支持的中文 HowTo：http://www.linux.org.tw/CLDP/HOWTO/hardware.html#hardware

### 各硬件设备在 Linux 中的文件名

**在 Linux 中，每个设备都被当成一个文件来对待**，
举例来说，SATA 接口的硬盘文件名称是 `/dev/sd[a-d]`，即 `/dev/sda`、`/dev/sdb` 等

下面列出几个常见的设备与在 linux 中的文件名

设备                | 在 linux 中的文件名
--------------------|--------------------------------------------------------------------------
SCS/SATA/USB 硬盘机 | `/dev/sd[a-p]`
USB 闪存盘          | `/dev/sd[a-p]`（同上）
Virtl/O界面         | `/dev/vd[a-p]` 用于虚拟机内
软盘机              | `/dev/fd/[0-7]`
打印机              | `/dev/lp[0-2]` 25 针打印机、`/dev/usb/lp[0-15]` USB 打印机
鼠标                | `/dev/input/mouse` 通用、`/dev/psaux` PS/2 界面、`/dev/mouse` 当前鼠标
CDROM/DVDROM        | `/dev/scd[0-1]` 通用、`/dev/sr[0-1]` 通用，CentOs 常见、`/dev/cdrom` 当前
磁带机              | 太老不记录
IDE 硬盘机          | `/dev/hd[a-d]` 老式系统才有


要注意的是使用云端机时，你得到的是虚拟机，为了加速，虚拟机内的磁盘使用仿真机产生，一般被命名为 `/dev/vd/[a-p]`

### 使用虚拟机来学习

虚拟化技术的成熟，个人计算机的 CPU 微指令集已经整合了硬件虚拟化指令集了，随便一台计算机就能够虚拟化出好几台逻辑独立的系统了

虚拟机软件有很多，在 windows 上可以使用 virtualbox ，在 Fedora/Ubuntu 等系列的话，使用内置的 KVM 就行了，
鸟哥后续章节使用的就是通过 KVM 创建出来的系统


## 磁盘分区
这一章在规划的重点是为了要安装 linux，与 windows 中的  c、d、e 盘不同，linux 的设备是以文件形态存在的

## 磁盘连接的方式与设备文件名的关系

- 正常的实体机一般使用 `/dev/sd[a-]` 的磁盘文件名
- 虚拟机一般会使用 `/dev/vd/[a-p]`

以 SATA 接口来说，由于 SATA/USB/SAS 等磁盘接口都是使用 SCS 模块来驱动的，
因此都是 `/dev/sd[a-p]` 的格式。假设同时存在你的计算机中呢？怎么确定他们各自对应的名称是什么？

确定顺序是按 Linux 核心侦测到的磁盘顺序分配文件名，是检测到的顺序，
比如 USB 是系统启动后才检测到，那么 USB 的文件名就是 `/dev/sdc`

还有一个问题，如果一个磁盘被分区了呢？那么每个分区的设备文件名又是什么？
在了解这个问题之前，需要先复习下磁盘的组成，因为现今磁盘的分区与他物理的组成很有关系

磁盘的组成部分主要有盘片、机械手臂、磁头与主轴马达所组成，数据的写入其实是在盘片上面。
盘片上面有可细分出扇区（Sector）与磁道（Track）两种单位，扇区的物理量设计有 512 Bytes 与 4 KBytes.
假设只有一个盘片，那么盘片有点像下面这样：

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-2019100312523146.png)

整颗磁盘的第一个扇区特别重要，因为记录了整颗磁盘的重要信息，早期磁盘第一个扇区里面含有 MBR(Master Boot Record) 格式，
由于近年来磁盘容量不断扩大，造成读写上的一些困扰，大于 2 TB 以上的磁盘分区已经让某些系统无法存取。
因此后来又多了一个新的磁盘分区格式，称为 GPT（GUID partition table），这两个分区格式与限制相差很大

那么分区表又是什么？上图的磁盘就像一根原木，必须要在上面切割出你想要的区段，这个区段才能制作出你想要的家具，
如果没有进行切割，那么原木就不能被有效的使用。所以需要对硬盘分区才能被使用

## MSDOS（MBR）与 GPT 磁盘分区表（partition table）

上面示例图中，有开始磁道和结束磁道，通常磁盘有多个盘片，所有盘片的同一个磁道我们成为柱面（Cylinder），
通常这是文件的系统的最小单位，也就是最小的分区单位。 但是在 GPT 中，可达到 64 bit 记录功能的分区表，
现在甚至可以使用扇区（sector）号码来作为分区单位了。

所以说就是利用参考对照柱面或扇区号码方式来处理。

### MSDOS (MBR) 分区表格式与限制
早期 Linux 系统为了兼容 Windows 磁盘，使用的是支持 Windows 的 MBR（Master boot record ，开机记录表）
的方式来处理开机管理程序与分区表。

开机管理程序记录区域分区表则通通放在磁盘的第一个扇区，通常是 512 Bytes 大小，第一个扇区 512 Bytes 会有以下两个数据：

- 主要开机记录区（Master Boot Record，MBR）：可以安装开机管理程序的地方，有 446 Bytes
- 分区表（partition table）：记录整颗硬盘分区的状态，有 64 Bytes

由于分区表仅有 64 Bytes，因此最大仅能有四组记录区，每组记录区记录了该区段的 **起始与结束的柱面号码**。
将硬盘以长条形来看，柱面以直条图来看，分区表的示意图如下

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-20191003131019717.png)

假设上面的磁盘设备文件名为 `/dev/sda` 时，那么这四个分区在 linux 中的设备文件名如下所示，
重点在于文件名后面的数字，数字与该分区所在的位置有关

- `p1:/dev/sda1`
- `p1:/dev/sda2`
- `p1:/dev/sda3`
- `p1:/dev/sda4`

由于只有 64 Bytes，最多只能容纳四笔分区记录，这 4 个分区的记录被称为主分区或延伸分区，
根据上面的图示与说明，可以得到几个重点信息

- 其实所谓的分区只是针对那个 64 Bytes 的分区表进行设置而已
- 硬盘默认的分区表仅能写入四组分区信息
- 这四组分区信息称为主要（Primary）或延伸（Extended）分区
- 分区的最小单位「通常」为柱面（cylindr）
- 当系统要写入磁盘时，一定会参考磁盘分区表，才能很对某个分区进行数据的处理

哪为什么需要分区呢？基本上可以这样思考分区的角度：

- 数据的安全性：如 windows 的 c、d、e，你可以抹掉 d 盘数据，但是 e 盘数据不受影响
- 系统的性能考虑：由于分区将数据几种在某个柱面的区段，假设该分区位于柱面号码 1~100 时，那么系统只需要读取 1~100 柱面，有助于数据的读与性能

那既然分区表只有记录四组数据的空间，是否代表一颗硬盘只能分出 4 个区？（笔者也有这个疑问）。

解决这个多分区的方式就是使用延伸分区，如下图所示

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-20191003132159888.png)

::: tip
实际上延伸分区不不是只占一个区块，而是会分布在每个分区的最前面几个扇区来记载分区信息
:::

上图中，P1 为主分区，P2 为延伸分区，延伸分区的目的是 **使用额外的扇区来记录分区信息，延伸分区本身并不能被拿来格式化**，
图右下方分隔出来了 5 个分区，这个被称为 **逻辑分区**（logical partition）

笔者看到这里就明白了，为什么以前在分硬盘的时候，有主分区，延伸（扩展）分区，还需要再分，
图上的关联关系来看，延伸分区的最小柱面单位是 512 Bytes，64 Bytes 可以存储 4 个分区记录，
那么 512 / 64 * 4 = 32 个分区记录，这就能分很多区了

同样的，上述的分区在 Linux 系统中的设备文件名分分别如下：

- `P1:/dev/sda1`
- `P1:/dev/sda2`
- `L1:/dev/sda[5-9]`

为啥从 5 开始了？前 4 个分区是保留给固定的 4 个分区用的。

MBR 主要分区、延伸分区与逻辑分区的特性简单定义：

- 主要分区与延伸分区最多可以有 4 个（硬盘限制）
- 延伸分区最多只能有一个（操作系统限制）
- 逻辑分区是由延伸分区持续切割出出来的分区

  延伸分区不可格式化，作为数据存取的分区主要为 主要分区和逻辑分区
- 逻辑分区的数量依操作系统而不同，linux 中 sata 硬盘已经开源突破 63 个以上的分区限制

由以上知识来看，分区表很重要，主分区与 MBR 更重要，几乎只要读取硬盘都会先由这个扇区先读起，
所以当第一个分扇区物理实体坏掉时，基本上这个硬盘就毁了。

经过以上的学习后，就会发现 MBR 分区表的限制中经常可以发现如下的问题

- 操作系统无法抓取到 2.2 T 以上的磁盘容量（笔记没有看懂这条，怎么就无法了？）
- MBR 仅有一个区块，若被破坏后，经常无法或很难救援
- MBR 内存放开机管理程序的区块仅为 445 Bytes，无法容纳较多的程序码

### GUID partition table，GPT 磁盘分区表

为了解决 MBR 的限制，出现了 GPT 。过去一个扇区只有 512 Bytes，目前已经有 4 K 扇区设计出现了。
为了兼容所有的磁盘，在扇区定义上大多会使用所谓的逻辑区块位置（Logical Block Address，LBA）来处理。
GPT 将磁盘所有区块以 LBA（默认为 512 Bytes）来规划，第一个 LBA 称为 LBA 0

GPT 使用了 34 个 LBA 区块来记录分区信息，同时整个磁盘最后 33 个 LBA 也拿来作为另一个备份，
就解决了 MBR 第一个扇区坏掉就不能读取的情况了，类似下图示意

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-20191003140230815.png)

上图个区解释如下：

- LBA0（MBR 相容区块）

  前 446 byte 存放开机管理程序，兼容 MBR，而原本的分区表的记录区放入一个特殊标识，表示是 GPT 格式，
  而不动 GPT 分区表的磁盘管理程序则不能识别该磁盘
- LBA1（GPT 表头记录）

  记录了分区表本身的位置与大小与被备份分区的存放位置，同时放置了分区表的校验机制码（CRC32),
  操作系统可以根据这个校验码来判断 GPT 是否正确。若有错误，则可通过这个记录区来取得备份的 GPT,
  来回复 GPT 的正常运行
- LBA2-33（实际记录分区信息处）

  从 LBA2 开始，每个 LBA 都可以记录 4 笔分区记录，在默认情况下总共可以有 4*32=128 笔分区记录，
  每个 LBA 有 512 Bytes，每笔记录用到 128 Bytes 的空间，除了每笔记录所需要的识别码与相关的
  记录之外， GPT 在每笔记录中分别提供了 64 bits 来记载开始/结束的扇区号码，
  因此，GPT 分区表对于单一分区来说，他的最大容量限制就会在「2^64 * 512 Bytes = 2^63 * 1 KBytes = 2^33 TB = 8 ZB,1 ZB = 2^30TB」

  笔者看不懂，反正就知道 GPT 单个分区可以很大很大

  linux kernel 通过 udev 等方式处理，没有分区限制了，想分多少分多少，
  而且 GPT 分区没有主、延伸、逻辑分区的概念，每笔记录都可以独立存在，可视为都是主分区，都能单独格式化

  反正也不太能看懂，总结下就是：

  - GPT 分区默认可以提供 128 笔记录（是有 128 个分区吗？）
  - Linux 内核通过 udev 方式，可以突破这限制
  - GPT 没有主、延伸、逻辑分区概念
  - 有网友测试分了 130+ 的分区，前 120 个都可以格式化使用，后面的视乎不行

虽然新版 Linux 大多能识别 GPT 分区，但是有部分软件不识别，如 fdsk，需要使用 gdsk、parted 指令（后面会讲解），
另外开机管理程序方面，grup 第一版不支持，grup2 才支持（后面会讲解）

不是所有的操作系统都可以读取到 GPT 的磁盘分区格式，也不是所有的硬件都支持 GPT 格式，
是否能够读写 GPT 格式与开机检测程序有关（BIOS 与 UEFI）

## 开机流程中的 BIOS 与 UEFI 开机检测程序
之前讲到，没有执行软件的硬件是没有用的，那么操作系统也是软件，开机时计算机还没有任何算计系统，
那么机器是如何读取硬盘内的操作系统文件的？这个就是开机程序的工作了

目前主机系统在载入硬件驱动方面的程序，主要有早期的 BIOS 与新的 UEFI 两种机制。

### BIOS 搭配 MBR/GPT 的开机流程

1. BIOS：开机主动执行的固件，会认识第一个可开机的设备
2. MBR：第一个可开机设备的第一个扇区内的组要开机记录区块，内含开机管理程序
3. 开机管理程序（boot loader）：载入核心文件
4. 核心文件：开始操作系统的功能

所以如果你的 BIOS 支持 GPT的话，那么就能够从 LBA0 的 MBR 相容区块读取第一阶段的开机管理程序码，
从而识别 GPT 格式的分区表

::: tip
由于 LBA0 仅提供第一阶段的开机管理程序码，因此如何使用类似 grub 的开机管理程序的话，
就需要额外分区出一个「BIOS boot」的分区来放置其他开机过程中所需的程序码，
在 CentOs 中一般占用 2 MB 左右
:::

BIOS 与 MBR 都是硬件本身会支持的功能，Boot loader 则是操作系统安装在 MBR 上面的一套软件。
由于 MBR 仅有 446 Bytes，因此开机管理程序是非常小而美的。
boot loader 的主要任务有以下几项：

- 提供菜单：使用者可以选择不同的开机项目，这也是多重开机的重要功能
- 载入核心文件：直接指向可开机的程序区段来开始操作系统
- 转交其他 loader：将开机管理功能转交给其他的 loader 负责

第三条怎么理解？硬盘不只有一个 MBR ，开机管理程序除了可以安装在 MBR 之外，还可以安装在每个分区的
开机扇区（boot sector），这个就是「多重开机」的功能

就是一块硬盘安装多个系统，比如 同时存在 windows 与 linux 系统，总结如下：

- 每个分区都拥有自己的开机扇区（boot sector）
- 实际可开机的核心文件是放置到各分区的
- loader 只会认识自己的系统盘内的可开机核心文件，以及其他的 loader 而已
- loader 可直接指向或则是间接将管理权转交给另一个管理程序

大家常说「如果安装多系统，最好先安装 windows 再安装 linux」这是因为：

- linux 在安装的时候，可以选择将开机管理程序安装在 MBR 或各分区的开机扇区，而且可以在  linux 的 boot loader 里面加入 windows 开机的选项
- windows 安装的时候，会主动覆盖掉 MBR 以及自己所在分区的开机扇区，你没有选择的机会，而且没有让我们自己选择菜单的功能

那么先安装 linux，后安装 windows，MBR 中的 linux 开机管理程序被覆盖掉后，只能重装 linux 一条路吗？
当然不是，还可以利用 linux 的救援模式来挽救 MBR

::: tip
开机管理程序与 Boot secrot 的观念非常重要，后面会仔细讲解
:::

### UEFI BIOS 搭配 GPT 开机的流程

MBR 的 BIOS 太落后了，出现了使用 C 写的 UEFI（Unified Extensible Firmware Interface）
统一可延伸固件界面

UEFI 主要是想取代 BIOS 固件，也称为 UEFI BIOS，如果开发者够厉害，可以在开机阶段就让该系统
了解 TCP/IP 而直接上网，根本不需要进入操作系统，这让小型系统的开发充满各式各样的可能性

基本上，传统 BIOS 与 UEFI 的差异可以用下表来说明

比较项目               | 传统 BIOS                                                   | UEFI
-----------------------|-------------------------------------------------------------|-------------------
使用程序语言           | 组合语言                                                    | C 语言
硬件资源控制           | 使用终端（IRQ)管理，不可变的内存存取，不可变的输入/输出存取 | 使用驱动程序与协定
处理器运行环境         | 16 位                                                       | CPU 保护模式
扩充方式               | 通过 IRQ 链接                                               | 直接载入驱动程序
第三方厂商支持         | 较差                                                        | 较佳且可支持多平台
图形化能力             | 较差                                                        | 较佳
内置简化操作系统前环境 | 不支持                                                      | 支持

通过上表，UEFI 就像是一个低阶的操作系统，连主板上面的硬件资源管理都与操作系统类似。

笔者感觉好复杂的 UEFI，总之目前 UEFI 一般用来作为启动操作系统之前的硬件检测、开机管理、软件设置等目的，
当载入系统后，就停会停止工作，将系统交给操作系统。

此外，由于过去 cracker 经常借由 BIOS 开机阶段来破坏系统，并取得控制权，因此 UEFI 加入了一个
安全启动（**secure boot**）机制，表示即将开机的操作系统必须被 UEFI 所验证，否则就无法顺利开机，
微软用了很多这样的机制来管理硬件。

不过有些时候可能启用该机制之后，无法进入 windows 或则 linux，需要关闭

UEFI 可以直接去的 GPT 分区表，不过最好依旧拥有 BIOS boot 的分区支持，同时，为了与 windows 相容，
并且提供其他第三方厂商所使用的 UEFI 应用程序存储的空间，你必须格式化一个 vfat 的文件系统，
大约提供 512 MB ~ 1G 左右的容量，以让其他 UEFI 执行较为方便

::: tip
由于 UEFI 克服了 BIOS 的 1024 柱面的问题，因此你的开机管理程序与核心放置磁盘开始前 2 TB
位置内即可，加上之前提到的 BIOS boot 以及 UEFI 支持的分区，基本上你的 `boot` 目录
几乎都是 `/dev/sda3` 之后的号码了，这样开机还是没有问题的，

与之前熟悉的分区状态已经不同， /boot 不再是 /dev/sda1 了
:::

### Linux 安装模式下，磁盘分区的选择（及其重要）
在 windows 上重装系统的时候，一般会考虑 c 盘多少容量，d 盘给多大容量，在实际安装的时候，
C 盘之前就会有个 100 MB 的分区被独立出来了，所以实际上就有 3 个分区了，
那 linux 下又该如何设计类似的东西呢？

#### 目录树结构（directory tree)
linux 下所有的数据都是以文件的形态来呈现的，所以最重要的就是目录树架构

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-20191003194556514.png)

所有文件都是由根目录「/」衍生而来的，上图长方形为目录，波浪形为文件，比如想要取得 mydata 那个文件时，
系统就得由根目录开始找，查找就形成了一条路径 `/home/dmtsai/mydata`

linux 系统使用的是目录树架构，但是我们文件数据其实是放置在磁盘分区槽当中的，
现在的问题是「如何结合目录树的架构与磁盘内的数据呢」？这个时候就需要用到「挂载（mount）」了

#### 文件系统与目录树的关系（挂载）

**挂载** 就是利用一个目录当成进入点，将磁盘分区槽的数据放置在该目录下。
也就是说，进入该目录就可以读取该分区槽的意思，这个动作我们成为挂载。

由于整个 Linux 系统最重要的就是根目录，因此根目录一定需要挂载到某个分区槽的，
至于其他的目录则可依据用户自己的需求来挂载到不同的分区槽

![](http://p6ui.toweydoc.tech:20080/images/stydocs/markdown-img-paste-20191003202333252.png)

- partition 1 挂载到根目录下
- partition 2 挂载到 /home 下

也就是说，当把数据放置在 /home 下时，是放在了 partition 2 上的，否则就是放在 partition 1 上的

#### distribution 安装时，挂载点与磁盘分区的规划

在安装 linux 系统时，必要要经历的就是磁盘分区了，一般都会内置好几种分区方式，
但是可能满足不了你需求，那么久可以使用「自定义模式（custom）」，有些 distribution 会把自定模式写成
「专家模式（Expert）」

- A: 初次接触 Linux：只要分区 「/」及「swap」即可

  原因是怕分错导致无法安装的困境，比如 /usr 是 linux 的可执行程序以及先关的文件摆放目录，
  所以对容量需求蛮大的，万一分小了，就安装不了了
- B：建议分区的方法：预留一个备用的深入磁盘容量

  在学习 linux 过程中，最麻烦的可能就是得常常处理分区的问题，如果你将整个硬盘的容量都用光了，
  那么要如何联系分区功能呢？

  另外，预留的分区槽也可以拿来作为备份用，比如你需要重装系统时，把一些重要的脚步备份到这个备用分区中，
  重装的时候就可以立马找到他们
- 选择 Linux 安装程序提供的默认硬盘分区方式

  对于首次接触 linux 的朋友们，通常不建议使用 distribution 所预设的 server 安装方式，
  因为会让你无法得知 linux 在搞什么，而且需要注意的是，选择 server 的时候，会自动把你硬盘里面所有的数据全部抹掉


## 安装 Linux 前的规划
安装最重要的第一件事情，就是你要从哪里拿到 linux distrbutions 的光盘数据？

## 选择适当的 distribution
前面已经讲到过了，所有的 linux distribution 都是使用 https://www.kernel.org 的 linux 核心，差异不是很大，根据自己的需求选择。

本次课程使用 CentOS 7.1，从 7.0 开始已经不再提供 386 兼容版本了，也就是只支持 64 位硬件

- 国家高速网络中心：http://ftp.twaren.net/Linux/CentOS/7/isos/
- CentOs 官网：http://mirror.centos.org/centos/7/isos/

版本说明：

- everything：完整版本
- DVD1：有大部分安装软件的版本
- LiveCD/LiveGNOME/LiveKDE：只想要看看到底开机会是说明 Linux 环境
- minimal：想要练功，就直接使用最小安装光盘版

CentOS-7-x86_64-Everything-1908.iso  下载的文档名中各个文字表示什么？

- CentOS-7 ：7.x 版本
- x86_64：指 64 位操作系统
- Everything ：指完整版本
- 1908：表示 2019 年 08 月发表的版本

笔者在以上网站查看的时候，7.1 目录下已经没有对于的 iso 文件了，只有剩下 readme 文件了，
里面说，普通用户不应该关注小版本，只需要关注 CentOs 7 即可，
所以我上面忒出来的镜像名称后面没有 `_01` 这种表示是 7.1 版本的含义，
而且从官网的 http://mirrors.163.com/centos/7.7.1908/isos/x86_64/ 7.7 点进去，
看到的镜像也是上面那样没有小版本了

不过 everthing 版本居然有 10 G 大小，太大了吧。这里我还是选择了 DVD 版本（4 G 左右）

## 主机的服务规划与硬件的关系
硬件的选择与你所需要用来做什么密切关联，这里就不再记录详细的，只记录可以用来做哪些事情，对应的硬件不详细记录

- 打造 windows 与 Linux 共存的环境：需要用到前面讲过的开机流程与多重引导知识
- NAT (达成 IP 分享器的功能)：

  对外一条出口 IP，内部通过这条联机联机到因特网上，
  使用 linux 的好处就是可以加装其他分析和管理软件，比某些 IP 分享器更高级的管理功能
- SAMBA（加入 windows 网络上的芳邻）
- Mail（邮件服务器）

  现在有很多免费的邮件服务商，但是对于企业内部，害怕隐私泄露什么的，可以自己安装 Mail 服务
- Web（www 服务器）

  WWW 服务服务器几乎是所有的网络主机都会安装的一个工能够，除了可以提供 Internet 的 www 联机之外，
  还提供一些分析软件提供的分析结果画面

  CentOS 使用的是 Apache 这套软件来达成 www 网站的功能
- DHCP（提供客户端自动取得 IP 的功能）

  如果你是个局域网网络管理员，你可以假设一个 DHCP 服务器，配置要求不高，
  貌似现在的各种路由器也都内置 DHCP 服务了
- FTP

  很多人喜欢假设 FTP 传输网络数据，甚至使用 FTP 传输非法数据，老实说，再怎么地下化也很容易被捉到，
  但是学校等组织经常需要 ftp 进行分享资源给全校师生一些免费的资源，此时匿名的 ftp 软件功能就很有需要存在了

  对于 ftp 的硬件需求来说，硬盘的容量与网络卡好坏相关性较高

## 主机硬盘的主要规划

除了上述的与用途之外，还需要对数据分类与数据安全性的考虑，所谓的数据安全，并不是说呗黑客所破坏，
而是当主机系统的硬件出现问题时，你的文件数据能否安全的保存

网络上经常有人问：因为非法关机（突然断电）等问题，导致 linux 无法开机，怎么办？
幸运的话，可以使用 fsck 来解决硬盘的问题，倒霉的话，可能需要重新安装 linux，
如果重装的话，光是搬移与备份数据就会疯掉了，使用硬盘的分区考虑是相当重要的

前面有讨论过 [磁盘分区了](./02.md) 了，但是硬盘规划对于刚入门而已，很是头痛，
因为需要对 linux 文件结构有相当程度的认知之后才能够做比较完善的规划，所以这里只要有个基础的认识即可。

老实说，没有安装过 10 次以上的 linux 系统，是学不会 linux 与磁盘分区的

这里说明一下基本硬盘分区的模式：

- 最简单的分区方法

  前面已经说过，只需要分区出 根目录 与内存置换空间（/ 与 swap）即可。
  再预留一些剩余的磁盘供后续练习使用，当然这是懒人分区方式，因为如果任何一个小细节坏掉（如坏轨的产生），
  你的根目录将可能整个的顺坏，挽救方面较困难
- 稍微麻烦一点的方式

  先分析出这部主机未来的用途，然后根据用途区分析需要较大容量的目录，以及读写较为频繁的目录，
  将这些重要的目录分别独立出来而不与根目录放在一起，当这些读写频繁的磁盘分区槽有问题时，
  至少不会影响到根目录的系统数据，挽救就比较容易了，在默认的 CentOS 环境下，下面的目录是比较符合
  大容量或读写频繁的目录：

  - /boot
  - /
  - /home
  - /var
  - Swap

## 鸟哥的两个实际案例

### 家用小型 linux 服务器，IP 分享与文件分享中
主要提供网络连接分享，需要 nat 功能。提供家庭成员数据存放容量

其他硬件不记录了，硬盘容量为一颗 640 GB 的硬盘，分区如下：

- 分成 `/`、`/usr`、`/var`、`/tmp` 等目录均独立
- 1 GB 的 swap
- 安装比较过时的 CentOs 5.x 最新版

### 提供 linux 的 PC 从集（cluster）计算机集群

主要提供研究室成员对于模式仿真的软、硬件平台，主要提供的服务并非英特网，而是内部研究工作分析

运用主机仅一颗磁盘，存储用主机提供 8 颗 2 TB 磁盘组成的磁盘阵列，
硬盘分区：

- 运算主机方面：整颗磁盘仅分 `/boot`、`/`、`swap`
- 存储主机方面：

  磁盘阵列分成两颗磁盘，一颗 100 G 给系统用，一颗 12 TB 给数据用。
  系统磁盘用的分区为 `/boot`、`/home`、`/tmp`、`/var`、等分区，
  数据磁盘全部容量规划在同一个分区槽

### 重点回顾

- 新购买计算机硬件配备时，需要考虑的角度有游戏、工作机、效能/价格比、效能/消耗瓦数、支持度等
- 旧的硬件配备可能由于保存的问题或则是电子零件老化的问题，导致计算机系统非常容易在运作过程中出现不明的宕机情况
- Red Hat 的硬件支持：https://hardware.redhat.com/?pagename=hcl
- 在 Linux 消停中，每个装置都被当成一个文件来对待，每个装置都有装置文件名
- 磁盘装置文件名通常分为两种，实际 SATA/USB 装置文件名为 `/dev/sd[a-p]`，虚拟机可能为 `/dev/vd/[a-p]`
- 磁盘的第一个扇区主要记录了两个重要的信息，

  1. 主要启动记录区（Master Boot Record，MBR)，可以安装卡机管理程序的地方，有 446 Bytes
  2. 分区表（partition table），记录整颗硬盘分区的状态，64 Bytes
- 磁盘的 MBR 分区方式中，主要与延伸分区最多可以有 4 个，逻辑分区的装置名号码一定由 5 号开始
- 如果磁盘容量大于 2 TB 以上时，系统会自动使用 GPT 分区方式来处理磁盘分区
- GPT 分区已经没有延伸与逻辑分区槽的概念，你可以想象成所有的分区都是主分区
- 某些操作系统使用 GPT 分区时，必须要搭配 UEFI 的新型 BIOS 格式才可以安装使用
- 开机的流程：

  1. BIOS
  2. MBR
  3. boot loader
  4. 核心文件
- boot loader 的功能主要有：提供选单、加载核心、转交控制权给其他 loader
- boot loader 可以安装的地点有两个：MBR 与 boot sector
- Linux 操作系统的文件使用目录树系统，与磁盘的对应需要有挂载的动作才行
- 新手的简单分区，建议只要有 「/」 和 swap 两个分区槽即可
