# 网络通信基本原理

网络通信（或通讯）模型和通讯协议（常见的 HTTP、TCP/IP、FTP等）解决的本质问题就是主机与主机之间的网络通信。

下面以最基本的两台主机之间的通信开始，慢慢认识网络通信模型和每层所做的事情，最后再学习 NodeJS 中提供的内置核心网络模块。

## 通信必要条件

抛开封装数据的部分，两台主机之间要想完成通信，至少需要满足的条件：

- 主机之间需要有传输介质建立物理连接
    - 如网线、蓝牙、光纤、wifi
- 主机上必须有网卡设备
    - 当两台主机建立了连接后就要考虑数据是以什么样的形式进行传输
    - 不论采用哪一种编程语言进行开发，在计算机的世界里所有的数据最终都会被转为二进制
    - 即便如此也只是解决了当前计算机识别数据的问题，而网络通信需要的是数据可以通过介质进行传输
    - 以网线为例，它能传输的就是电信号，源源不断的高低电压，而不是 1 和 0 组成的数字，所以每个通信的主机上就要有一个网卡设备
    - 网卡可以完成信号的调制和解调制，其中把二进制的数据转为高低电压的过程就是数据的调制过程
    - 例如，现在有 A、B 两台主机建立了网线的连接想进行通信，这时 A 主机上就会将封装好的数据经过 A 的网卡之后进行调制，将其处理成电信号，这个电信号经过网线传到了 B 主机上，接着 B 主机上的网卡就会进行解调制拿到封装后的数据，之后由 B 主机本身的通信体系进行拆包解包，最终由某个应用程序获取 A 主机发送过来的数据
- 主机之间需要协商网络速率
    - 因为 A、B 两台主机的网卡可能速率不一样，它们每秒传输的电信号也就不一样，所以在 A、B 主机通信之前，还要协商网络速率

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/46e9f3e436fb4c9faedbeaf532c04441.png)

## 网络通讯方式

网络通讯过程中最常见的两种通讯方式：

- 交换机通讯
- 路由器通讯

### 如何建立对台主机互连？

我们日常所处的网络不可能只存在两台主机，依据通讯的基础条件，首先要考虑的就是如何讲我们的电脑与别的电脑进行连接

假如要与另外 10 台电脑进行通讯，不可能购买一台具有 10 个网卡设备的电脑，这个时候就可以用过**交换机**完成这个事情。

通过交换机可以多台电脑进行连接（不考虑交换机的层级）。

当通过交换机把多台主机连接在一起之后，它们就形成了一个网络，而这个网络就是日常所说的**局域网**。

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/783263221a3545d39818b86fd797cbe4.png)

### 如何定位局域网中的其它主机？

对于 主机A 来说，它是不认识其它主机的，当 主机A 想和 主机B 通讯的时候该如何找到主机B？这个操作最终会有交换机来完成。

任意一台主机都有一个唯一标识网卡设备的地址：**Mac 地址**，称之为**物理地址**。

以广播的方式为例，主机可以把消息发送给交换机，交换机接收到消息后再通知其它所有的机器，在这个过程中其它所有的机器就都会收到这条消息，真正的 主机B 就会发现 主机A 想找到是自己，而其它的主机就会将这次的消息当作垃圾丢弃。

这个过程就是通过交换机来完成局域网通讯的操作。

这种通讯的模式有一些小问题，同时无法满足当前互联网需求，例如：

- 交换机的接口数量有上限
    - 不可能将所有的电脑都放在一个局域网内
- 局域网存在大量主机会造成广播风暴
    - 任意一条消息的发送，都需要被其它主机接收，然后再确认是否有效

基于这种情况，网络就被分成了很多个较小的局域网，然后就是城域网，直到最大的互联网。

### 不同局域网的主机如何通讯？

分属不同局域网的主机要想通讯就需要用到**路由器**来完成数据的交换。

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/025bb2da20164da28f912f86561b3da4.png)

- 首先 局域网1-主机A（下称 A）要想访问 局域网2-主机B（下称 B），不仅需要知道 B 的网卡地址，还需要知道它在哪一个网络里。这就需要 IP 地址。
- 数据在发送的时候，不仅仅包含程序代码所接收到的数据，还有**源 Mac 地址、源 IP 地址、目标 Mac 地址以及目标 IP** 等，这些内容首先会被组装成一条数据，之后会发送到路由器上面
- 路由器可以识别目标主机是否在当前局域网内，如果不在，路由器会按照路由表上记录的信息通过网络路由找到对应的网络，然后再把数据发送过去
- 发送到对应的网络后，由那边的交换机完成最后的定位功能
- 这样就完成了不同网络之间的主机通讯

---

_这里的目的不是为了详尽的理解网络通讯发生的每个细节，例如静态/动态路由的设置或者 IP 地址的动态分配等，更多是明确通讯的流程和一些核心的概念，例如通讯需要具备的条件；通讯是双向的，一定是有来有回；数据在传输的过程中会与 IP 地址和 Mac 地址包裹在一起。_

# [网络层](https://so.csdn.net/so/search?q=%E7%BD%91%E7%BB%9C%E5%B1%82&spm=1001.2101.3001.7020)次模型

_对网络的分层有一个清晰的结构认识，不需要掌握每层是如何完成具体工作的。_

---

网络通讯是一个复杂的工程，需要很多基础硬件设备，而这些设备又有很多厂商进行生产，所以为了方便网络的实施、管理和维护，就会有组织推出相应的行业标准规范，目前最常见的就是 OSI 七层模型模型和 TCP/IP 四层模型。

> 注意：这里的 TCP/IP 并不单指这两个协议，只是在 OSI 七层模型的基础上进行了一些简化，形成了另外一个网络通讯模型。

不论现在使用哪一种模型，它们都是对通讯的过程进行分层，每层当中存在很多协议，例如 HTTP 就属于应用层协议，而 TCP、UDP 就属于传输层协议。

## OSI 七层模型

按照自上往下的顺序每层分别是：

- 应用层：用户（或应用程序）与网络的接口
    - 可以利用不同的协议完成用户请求的各种服务
    - 例如，可以利用 HTTP 协议完成网站服务；利用 FTP 协议完成文件传输服务；利用 SSH 协议完成远程登陆服务等
- 表示层：数据加密、转换、压缩
- 会话层：控制网络连接建立与终止
- 传输层：控制数据传输可靠性
    - 这一层是基于端口的协议层，所以数据在封装的时候必须携带目标程序所占用的端口号
- 网络层：确定目标网络
    - 通过路由找到目标网络。常见的就是 IP 协议，可以依据 IP 地址确定源和目标的网络
- 数据链路层：确定目标主机
    - 在确定了目标网络并进入某个局域网内后通过 Mac 地址确定目标主机。常见的就是 ARP 寻址协议
- 物理层：各种物理设备和标准

## 数据传递，先封装再解封

数据从 主机A 传递到 主机B，首先要按照分层自上向下的顺序，一层一层的进行数据的封装，然后到了 主机B 的网卡解调之后，再按照自下向上的顺序进行拆解，最后在应用程序中拿到 主机A 发送的原始数据。

## 总结

**OSI 七层模型**的目的是更加清晰规范的完成网络通讯。

**TCP/IP 四层模型**就是在它的基础之上，将前三层（_应用层、表示层、会话层_）进行合并，统一叫做**应用层**。再将_数据链路层和物理层_合并称为**网络接入层**。最终为**应用层–传输层–网络层–网络接入层**。

**TCP/IP 五层模型**就是保留**数据链路层**和**物理层**，也有称这两层为**网络接口层**和**硬件**。

不论是四层还是五层，层的名称是什么只要理解其中原理即可。

这里主要了解的是分层的目的，七层的名称和作用，以及常见的协议名称。

# 数据封装与解封装

_依据网络通讯的层次模型，以 TCP/IP 五层模型为例，具体的说一下传输数据的封装与解封装的过程。_

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/f05fda8fd80a4d84ab81986270b4a988.png)

- 应用层：首先在应用层产出真正要被传输的数据 data，然后将其传输到传输层
- 传输层：传输层最常见的是 TCP、UDP 协议，它们都是基于端口的，端口的作用就是在主机上确定唯一进程，所以数据在这层就会包裹上目标应用端口和应用在当前主机上的源端口，接着数据被传向网络层
- 网络层：因为主机处于不同的网络里，所以需要通过 IP 协议确定目标主机所在的网络，因此数据在这层会被包裹上目标主机的 IP 地址和当前主机的源 IP，接着数据被传向链路层
- 数据链路层：在数据链路层最主要的就是通过 Mac 地址完成寻址操作，所以数据在这层会被包裹上目标主机的 Mac 地址和当前主机的 Mac 地址，至此一条具有完整信息的数据就封装完成了，接着数据被传向物理层
- 物理层：网线不能传递二进制数据，这些二进制数据在经过网卡的调制之后，变成高低电压（图中以二进制形式表示转换后的数据）

有了这些数据后，经过路由器的网络分配和传输介质的运输，最终就到达了目标主机的网卡：

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/41512f13cfc544bd986a668199b955c1.png)

- 物理层：首先会做数据的解调，将电压变为二进制，然后再向上传递给链路层
- 数据链路层：在链路层就会分析目标的 Mac 地址是否与当前主机的 Mac 地址一致，如果一致则进行拆包，继续向上传递到网络层
- 网络层：在这一层会分析目标 IP 是否与当前主机的 IP，如果是，则继续拆包向上传输到传输层
- 传输层：这里会检查目标端口是否匹配，如果匹配，则继续拆包向上层传输
- 应用层：现在当前网络的目标主机的应用就拿到由另一个网络中的某台主机的某个应用所传递过来的数据

这个过程就是数据在通讯过程中的封装与解封的步骤。

# TCP [三次握手](https://so.csdn.net/so/search?q=%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B&spm=1001.2101.3001.7020)与四次挥手

_目的是了解三次握手建立和四次挥手的过程，而不是深究底层是如何实现的。_

## TCP 协议

- TCP 属于传输层协议
- TCP 是面向连接的协议
- TCP 一般用于处理实时通信

### TCP 协议报文结构

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/aca846163451436eaed4e30da6c2297a.png)

这里主要了解端口和常见控制字段的意思。

端口的作用就是为了标明自己和目标应用进程。

常见控制字段：

- SYN = 1 表示请求建立连接
- FIN = 1 表示请求断开连接
- ACK = 1 表示数据信息确认

## 三次握手建立过程

以 C/S 架构为例：

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/17c33ca6993a438c9148e2b2ae5d183f.png)

- 首先客户端要向服务端发送一个建立连接的请求（图中以 SYN=1 表示）
- 然后服务端接收到请求后就会回送一条消息，表示确认接收到了客户端的请求（图中以 ACK=1 表示）
    - 任何一次完整的通信都是有来有回的
    - 这两次请求和回送完成之后就建立了一条由**客户端向服务端**发送数据的通道
- 服务端想要向客户端发送数据，同样需要发送一个请求给客户端，表示它也想建立连接（图中以 SYC=1 表示）
- 同样客户端也需要回送一个确认消息给服务端，表示接收到了请求（图中以 ACK=1 表示）
    - 至此就建立了一条由**服务端向客户端**发送数据的通道

所以这四次连接之后，就有了一个客户端和服务端之间进行数据通讯的双向通道。

不过上图看着像四次握手，而不是三次。其实本来就是四次握手，只不过在实际处理的时候，服务端会在回送客户端 ACK=1 的时候同时还会发送 SYN=1，也就是说它会将这两次握手进行合并，这样就有了最终的**三次握手**：

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/341907fd46b64517a956802e7ba5a6be.png)

## 四次挥手过程

当客户端与服务器的数据传输结束之后就应该断开连接，让服务端可以处理其它客户端的请求。

![在这里插入图片描述](http://p4ui.toweydoc.tech:20080/images/stydocs/8ba7f3eff161430fb20715f275a8f510.png)

- 首先客户端会向服务端发送一个断开连接的请求
- 然后服务端会回送一个消息确认，这时就相当于断开了**客户端到服务端**的数据通道
- 接着服务端会向客户端发送一个断开连接的请求
- 客户端收到后也会回送一个确认消息给服务端，断开了**服务端到客户端**的数据通道.

这样就断开了服务端与客户端之间的数据通道，所以这个过程就有了四次挥手。

## 为什么握手可以三次，而挥手必须四次？

至于为什么不将服务端回送客户端的确认消息和服务端请求与客户端断开连接的请求进行合并？

因为**一个服务端会服务于多个客户端**，不能保证某个客户端将请求发送给服务端之后，服务端就能立即将结果数据全部传输回给当前客户端。

也就是说，有些时候客户端已经把所有的数据都发送给服务端了，但是服务端还没有将客户端想要的数据全部传回，所以在断开连接的时候要分开处理，可以断开客户端向服务端传输的通道，但还不能断开服务端向客户端传输的通道。

因此**挥手必须要有四次，而握手就可以合并为三次**。

## 总结

- TCP 处于传输层，基于端口，面向连接
- 主机之间要想通信需要先建立双向数据通道
- TCP 的握手和挥手本质上都是四次，只不过在断开的时候不能进行合并